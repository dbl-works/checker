#!/usr/bin/env ruby

STDERR.sync = STDOUT.sync = true

require_relative '../lib/dbl_checker/manager/client'
require_relative '../lib/dbl_checker/manager/healthz'

environment = ENV['RAILS_ENV'] || 'development'

client_pid = fork do
  `export RAILS_ENV=#{environment}`
  `export DBL_CHECKER_MOCK_REMOTE=true` if environment == 'development'
  DblChecker::Manager::Client.new.run
end

puts "started manager with pid: #{client_pid}"

DblChecker::Manager::Healthz.new.serve(client_pid)
